<head>
    <style> body { margin: 0; } </style>
  
    <script src="//unpkg.com/3d-force-graph"></script>
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/three-spritetext"></script>
    <!--<script src="../../dist/3d-force-graph.js"></script>-->
    <link rel="stylesheet" href="viz/style.css">
    <script type="text/javascript" language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>  
  </head>
  
  <body style="background-color:black;">
    
    <div id="3d-graph"></div>
    <div class="color-selector">
        <input type="radio" name="color_radio" id='Standard' checked> Reached
        <input type="radio" name="color_radio" id='Techno'> Techno
        <input type="radio" name="color_radio" id='Flux'> Flux
        <input type="radio" name="color_radio" id='Temp'> Temp
        <input type="radio" name="color_radio" id='Gravity'> Gravity
        <input type="radio" name="color_radio" id='Biome'> Biome
        <input type="radio" name="color_radio" id='Pop'> Pop density
        <input type="radio" name="color_radio" id='Inh'> Inhabitants
        <input type="radio" name="color_radio" id='Reaction'> Social
    </div>
    <div class="graph-legend">
      <span id="graph-data-legend"></span>
    </div>
    <div class="graph-data">
        <span id="graph-data-description"></span>
    </div>
    <div class="visible-selector">
      <div class="node-visible-selector">
        Nodes
        <input type="checkbox" name='node_vis_box' id='Reached' checked> Reached
        <input type="checkbox" name='node_vis_box' id='Unreached' checked> Unreached
      </div>
      <div class="link-visible-selector">
        Links
        <input type="checkbox" name='link_vis_box' id='Reached' checked> Reached
        <input type="checkbox" name='link_vis_box' id='Unreached'> Unreached
      </div>

    </div>



    <!-- <script id="legend" src="viz/legend.json" type="application/json"></script> -->
    <script type="module">
      import { UnrealBloomPass } from '//unpkg.com/three/examples/jsm/postprocessing/UnrealBloomPass.js';
      // import { AfterimagePass  } from '//unpkg.com/three/examples/jsm/postprocessing/AfterimagePass.js';
      const elem = document.getElementById('3d-graph');


      const pathNodes = new Set();
      const hpathNodes = new Set();
      const highlightNodes = new Set();
      let hoverNode = null;
      let rclickedNode = null;
      let scale_factor = 1;
      let node_color_filter = "Standard";
      var legend = null;

      var link_reached_visible = true;
      var node_reached_visible = true;
      var link_unreached_visible = false;
      var node_unreached_visible = true;
      var attrib_filter = ''
      var hover_activated = false;
      var three_objects = {}

      $.getJSON("viz/legend.json", function(json) {
          legend = json;
          document.getElementById('graph-data-legend').innerHTML = get_legend(node_color_filter);
          document.querySelectorAll('div.legend-box').forEach((box) => {
            box.addEventListener("click", function(event) {
              let new_filter = event.srcElement.id;
              if(new_filter == attrib_filter)
                attrib_filter = '';
              else
                attrib_filter = new_filter;
                updateHighlight();
            });
          });
      });

      $(document).bind("keyup keydown", function (e) {
        if (e.ctrlKey) {
          hover_activated = !hover_activated;
        }
      });

      function get_node_name_obj(node) {
        if(node.id in three_objects)
          return three_objects[node.id];

        const sprite = new SpriteText(`${node.name}` + '\n\n\n');
        sprite.color = 'lightgrey';
        sprite.textHeight = 9;
        three_objects[node.id] = sprite
        return sprite;
      }
  
      function get_color_from_legend(node) {
        let value = node.planet[node_color_filter][0];
        for (let i in legend[node_color_filter]) {
          if(legend[node_color_filter][i][0] == value)
            return legend[node_color_filter][i][1];
        }
      }

      function node_color(node){
        if(node.id == 0) return '#FFDD33';

        if(node_color_filter != "Standard") {
          return get_color_from_legend(node);
          // let color = node[node_color_filter];
          return color;
        }
        
        if (hoverNode) {
          if (hoverNode.id == node.id) return '#FF11AA';
          else if ((hover_activated || rclickedNode) && pathNodes.has(node.id)) return '#11DD11';
          else if ((hover_activated || rclickedNode) && highlightNodes.has(node.id)) return '#FF3333';
        }
        if (node.reached == 1) {
          return '#ede68a';
        }

        return node["dark"]
        // return '#222831';
      }

      function get_legend(key) {
        if (key == 'Standard') {
          key = 'dark'
        }
        if(key == '') return ''
        var txt = "";
        for (let i in legend[key]) {
          txt += "<div class='legend-box' id='" +  legend[key][i][0] + "' style='background-color:" 
              + legend[key][i][1] + "'></div><b class='legend-txt'> " + legend[key][i][0] + "</b>  ";
        }
        return txt;
      }

      // if (document.querySelector('input[name="color_radio"]')) {
      document.querySelectorAll('input[name="color_radio"]').forEach((elem) => {
        elem.addEventListener("change", function(event) {
          node_color_filter = event.target.id;
          attrib_filter = '';
          if(legend != null) {
            document.getElementById('graph-data-legend').innerHTML = get_legend(node_color_filter);
            document.querySelectorAll('div.legend-box').forEach((box) => {
              box.addEventListener("click", function(event) {
                let new_filter = event.srcElement.id;
                if(new_filter == attrib_filter)
                  attrib_filter = '';
                else
                  attrib_filter = new_filter;
                  updateHighlight();
              });
            });
          }
          updateHighlight();
        });
      });
      // }

      document.querySelectorAll('input[name="node_vis_box"]').forEach((elem) => {
        elem.addEventListener("change", function(event) {
          let type = event.target.id;
          if(type == 'Reached') node_reached_visible = event.srcElement.checked;
          if(type == 'Unreached') node_unreached_visible = event.srcElement.checked;
          updateHighlight();
        });
      });

      document.querySelectorAll('input[name="link_vis_box"]').forEach((elem) => {
        elem.addEventListener("change", function(event) {
          let type = event.target.id;
          if(type == 'Reached') link_reached_visible = event.srcElement.checked;
          if(type == 'Unreached') link_unreached_visible = event.srcElement.checked;
          updateHighlight();
        });
      });
      
      function node_opacity(node){
        if(node.id == 0) return 1;
        
        if (hoverNode) {
          if (hoverNode.id == node.id) return 1;
          else if (pathNodes.has(node.id)) return 1;
          else if (highlightNodes.has(node.id)) return 1;
        }
        if (node.reached == 1) {
          return 1;
        }

        return 0.6;
      }

      function node_size(node){
        return scale_factor * (node.reached == 1 ? (node.id == 0 ? 30 : 4) : 2);
      }

      const Graph = ForceGraph3D()(elem)
        .jsonUrl('viz/multivers.json')
        .nodeColor(node => {
          return node_color(node);
        })
        .nodeThreeObjectExtend(true)
        .nodeThreeObject(node => {
          if(node.reached == 0 && !rclickedNode) return null;
          return get_node_name_obj(node);
        })
        .linkColor(link => {
          if (hoverNode && (hover_activated || rclickedNode)) {
            if ((pathNodes.has(link.source.id) && pathNodes.has(link.target.id))) {
              if (link.unreached == 0) 
                return "#77FFAA";
              return "#11DD11";
            } else if (hoverNode.id == link.source.id || hoverNode.id == link.target.id) {
              return link.unreached == 1 ? '#AA0000' : '#FF2222';
            } else if((hpathNodes.has(link.source.id) && hpathNodes.has(link.target.id)))
              return "#DD55DD";
          }
          return link.unreached == 1 ? '#333333' : ( (node_color_filter != "Standard") ? '#333333' : '#14ffec');         
        })

        .linkVisibility(link => {
         if(rclickedNode != null || ( hoverNode != null && hover_activated) ) {
            if(highlightNodes.has(link.source.id) && hoverNode.id == link.target.id)
              return true;
            if(highlightNodes.has(link.target.id) && hoverNode.id == link.source.id)
              return true;
            if(hoverNode.neighbors.includes(link.target.id) || hoverNode.neighbors.includes(link.source.id))
              return true;
            if((pathNodes.has(link.source.id) && pathNodes.has(link.target.id)))
              return true;
            if((hpathNodes.has(link.source.id) && hpathNodes.has(link.target.id)))
              return true;
              
            if (rclickedNode != null)
              return false;
          }

          if(link.unreached == 1 && ( hoverNode != null && hover_activated)) {
            if(highlightNodes.has(link.source.id) && hoverNode.id == link.target.id)
              return true;
            if(highlightNodes.has(link.target.id) && hoverNode.id == link.source.id)
              return true;  
            if((pathNodes.has(link.source.id) && pathNodes.has(link.target.id)))
              return true;
            return link_unreached_visible;  
          } 

          if(!link_unreached_visible && link['unreached'] == 1)
            return false;
          if(!link_reached_visible && link['unreached'] == 0)
            return false;
          
          return true;
        })

        .nodeVisibility(node => {
          if(node.id == 0) return true;
          if(rclickedNode != null) {
            return highlightNodes.has(node.id)
                  || node.neighbors.some((neigh)=>highlightNodes.has(neigh))
                  || hpathNodes.has(node.id) 
                  || pathNodes.has(node.id);
          }

          if(hoverNode && hover_activated) {
            if (highlightNodes.has(node.id)
                  || node.neighbors.some((neigh)=>highlightNodes.has(neigh))
                  || hpathNodes.has(node.id) 
                  || pathNodes.has(node.id))
                  return true;
          }

          if(!node_unreached_visible && node['reached'] == 0)
            return false;
          if(!node_reached_visible && node['reached'] == 1)
            return false;

          if(attrib_filter != ''){
            let cat = node_color_filter;
            if (node_color_filter == "Standard")
              cat = "Reaction";
            if(!node['planet'][cat].includes(attrib_filter))
              return false;            
          }

          return true;
        })
        .nodeVal(node => scale_factor * (node.reached == 1 ? (node.id == 0 ? 30 : 4) : 2))
        // .nodeOpacity(node => node.unreached == 1 ? 0.3 : 0.6)
        .nodeLabel(node => `${node.name}`)
        .onNodeHover(node => {
          if ((!node && !highlightNodes.size) || (node && hoverNode === node)) return;

          elem.style.cursor = node ? 'pointer' : null
          if(!rclickedNode) {
            focus_on(node)
          }
        })
        .onNodeClick( (node, event) => {
          if (node == rclickedNode)
            rclickedNode = null;
          else
            rclickedNode = node;

          focus_on(node);
        })
        .linkOpacity(1)
        .linkWidth(link => scale_factor *  (link.unreached == 1 ? 0.75 : 1.5))
        .nodeOpacity(1)
        .linkDirectionalParticles((link)=> link.unreached == 1 ? 0 : 3)
        .linkDirectionalParticleSpeed(0.01)
        .linkDirectionalParticleWidth(scale_factor * 5)
        .linkDirectionalParticleColor("#FFFFFF")
        .onNodeRightClick(node =>{ 
          // console.log(node)
          // Aim at node from outside it
          const distance = 300;
          const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);

          Graph.cameraPosition(
            { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
            node, // lookAt ({ x, y, z })
            2000  // ms transition duration
          );
        
        })//window.open(`https://bl.ocks.org/${node.user}/${node.id}`, '_blank'));
        .onLinkClick(link => console.log(link));

        function get_txt(node) {
          if(!node) return ''
          if(node.id == 0) return "<h2><b> La Terre </b></h2>"
          var txt = "<h2><b>" + node.name + "</b></h2>";
          // txt += "<p style='text-align:left'>";
          for (let key in node.planet) {
            txt += "<b>" + key + "</b>:  " + node.planet[key].join(', ') + "<br>";
          }
          // txt += "</p>";
          if(node_color_filter != "Standard") {
            txt += "<h2><b>" + node.planet[node_color_filter].join(', ') + "</b></h2>";
          } else {
            txt += "<h2> </h2>";
          }
          
          txt += "<b>Plus court:</b>:  " + node.s_path.length + "<br>";
          if(node.h_path.length !=  node.hs_path_kn.length)
            txt += "<b>Plus simple:</b>:  " + node.hs_path_unkn.length + " + " + node.hs_path_kn.length + "<br>";
          if(node.h_path.length > 0)
            txt += "<b>Connu:</b>:  " + node.h_path.length + "<br>";
          return txt;
        }

        function focus_on(node) {
          highlightNodes.clear();
          pathNodes.clear();
          hpathNodes.clear();
          if (node) {
            highlightNodes.add(node.id);
            node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
            node.s_path.forEach(n => pathNodes.add(n));
            // node.h_path.forEach(n => hpathNodes.add(n));
            node.hs_path.forEach(n => hpathNodes.add(n));
            document.getElementById('graph-data-description').innerHTML = get_txt(node);
          }
          hoverNode = node || null;
          updateHighlight();
        }

        const bloomPass = new UnrealBloomPass();
        bloomPass.strength = 1.5;
        bloomPass.radius = 0.4;
        bloomPass.threshold = 0.2;
        Graph.postProcessingComposer().addPass(bloomPass);
              
        
        // const loader = new THREE.CubeTextureLoader();
        // const texture = loader.load([
        //   'viz/sky_neg_x.jpg',
        //   'viz/sky_pos_x.jpg',
        //   'viz/sky_pos_y.jpg',
        //   'viz/sky_neg_y.jpg',
        //   'viz/sky_neg_z.jpg',
        //   'viz/sky_pos_z.jpg',
        // ]);
        // Graph.scene().background = texture;



        function updateHighlight() {
          Graph
            .nodeColor(Graph.nodeColor())
            .linkWidth(Graph.linkWidth())
            .nodeThreeObject(node => {
                if(node.reached == 0 && !rclickedNode) return null;
                return get_node_name_obj(node);
              })
            .linkDirectionalParticles(Graph.linkDirectionalParticles());
        }


    </script>
  </body>